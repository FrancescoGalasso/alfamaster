{% extends 'product/base.html' %}

{% block content %}

{% if user.is_authenticated %}
    {% if user.is_superuser %}
    <!-- <div>Filter owner </div>
    <div style="display: flex;"id="search"> 
        <select name="myselect" id="products">
            <option value="all">all</option>
        </select>
            <button class="btn btn-default" type="button" tabindex="-1"><span class="glyphicon glyphicon-search" aria-hidden="true" id="searchBtn"></span></button>
    </div> -->
    <input type="text" id="myInput" onkeyup="myFunction()" placeholder="Search for owners ..">

    {% endif %}
    <table id = "myTable">
    {% for product in products %}
    <tr style="border-bottom: 1px solid gray">
        <td><h1><a id="product" href="{% url 'product_detail' pk=product.pk %}">{{ product.name }}</a></h1></td>
        {% if user.is_superuser %}
            <td style="float: left; margin-top: 25px; margin-left: 350px;" >{{product.owner}}</td>
        {% endif %}
        <td><button type="button" class="btn btn-danger" href= "{% url 'product_erase' pk=product.pk %}" onclick="callModal(this)" style="float: left; margin-top: 7px; margin-left: 150px; ">Delete </button></td>
    </tr>
    {% endfor %}
    </table>
{% elif not user.is_authenticated %}
    <a href="{% url 'login' %}">login</a>
{% endif %}

<script>
    var url = ""
    function callModal(obj){
        url = obj.getAttribute("href")
        console.log(url)
        var parent = $(obj).parent().parent()
        var firstElem = parent[0].firstElementChild
        var children = firstElem.children[0]
        var name_prod = children.innerText 
        $('.modal-title').text('DELETE '+name_prod)
        $('#myModal').modal('show');
    }

    // $(window).bind("load", function() {
    // // code here
    //     console.log("loaded")
    //     var $products = $("#products");

    //     var objs = $('table tr td:nth-child(2)')
    //     var listofTmp = []
    //     for (var k=0; k<objs.length; k++){
    //         listofTmp.push(objs[k].innerText)
    //     }
    //     function onlyUnique(value, index, self) { 
    //         return self.indexOf(value) === index;
    //     }
    //     var listofUniqueOwner = listofTmp.filter( onlyUnique ); 

    //     $.each(listofUniqueOwner, function(val, text) {
    //         $('#products').append( $('<option></option>').val(text).html(text) )
    //     });

    // });
    
    // $('#searchBtn').on('click', function(){
    //         var value = $('#products').val()
    //         if(value != "all"){
    //             $("tr:not(:contains('"+value+"'))").hide ();
    //             $("tr:contains('"+value+"')").show ();
    //         }else{
    //             $("tr:not(:contains('"+value+"'))").show ();
    //         }
    // });

    function myFunction() {
  // Declare variables 
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("myInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("myTable");
        tr = table.getElementsByTagName("tr");

        // Loop through all table rows, and hide those who don't match the search query
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[1];
            if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
            } 
        }
    }
    
</script>

<!-- Modal -->
<div class="modal fade" id="myModal" role="dialog">
        <script>
            // on load of modal
            $('#myModal').on('show.bs.modal', function () {
                // do somethingâ€¦
                var htmlForm = document.getElementById('eraseForm')
                htmlForm.action = url
            })
        </script>
    
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"></h4>
                </div>
                <div class="modal-body">
                    <p>Delete this product and all his history?</p>
                    <p>THIS ACTION IS IRREVERSIBLE</p>
                </div>
                <div class="modal-footer">
                    <form action="" method="post" id="eraseForm">
                            {% csrf_token %}
                    <input class="btn btn-danger" type="submit" value="Delete" >  
                    </form> 
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}